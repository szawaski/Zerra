// Copyright © KaKush LLC
// Written By Steven Zawaski
// Licensed to you under the MIT license

using System;
using System.Linq;
using System.Reflection;
using Zerra.Reflection;

namespace Zerra.Repository.Reflection
{
    public sealed class ModelPropertyDetail
    {
        public MemberInfo MemberInfo { get; }
        public bool IsDataSourceEntity { get; }

        public string Name { get; }
        public Type Type { get; }
        public CoreType? CoreType { get; }
        public string PropertySourceName { get; }
        public bool IsIdentity { get; } //Usually maps to DB PrimaryKey
        public bool IsIdentityAutoGenerated { get; } //Usually maps to DB Identity Specification (Auto Increment)
        public bool IsRelated { get; }
        public string? ForeignIdentity { get; }
        public bool IsEnumerable { get; }
        public bool IsNullable { get; }
        public Type InnerType { get; }
        public CoreType? InnerCoreType { get; }
        public bool IsDataSourceNotNull { get; }
        public int? DataSourcePrecisionLength { get; }
        public int? DataSourceScale { get; }
        public StoreTextEncoding TextEncoding { get; }
        public StoreDatePart DatePart { get; }

        public Func<object, object?> Getter { get; }
        public Action<object, object?> Setter { get; }

        public object CoreTypeSetter { get; }

        public override string ToString()
        {
            return $"{Type.Name} {Name}";
        }

        internal ModelPropertyDetail(MemberDetail memberDetail, bool declaringTypeIsDataSourceEntity)
        {
            this.MemberInfo = memberDetail.MemberInfo;

            this.Name = memberDetail.Name;
            this.Type = memberDetail.Type;
            this.CoreType = memberDetail.TypeDetailBoxed.CoreType;
            this.IsNullable = memberDetail.TypeDetailBoxed.IsNullable;
            this.IsEnumerable = memberDetail.TypeDetailBoxed.HasIEnumerable;
            this.InnerType = memberDetail.TypeDetailBoxed.InnerTypes?.Count > 0 ? memberDetail.TypeDetailBoxed.InnerType : memberDetail.TypeDetailBoxed.Type;
            this.InnerCoreType = memberDetail.TypeDetailBoxed.InnerTypes?.Count > 0 ? memberDetail.TypeDetailBoxed.InnerTypeDetail.CoreType : memberDetail.TypeDetailBoxed.CoreType;

            var sourcePropertyAttribute = memberDetail.Attributes.Select(x => x as StoreNameAttribute).Where(x => x is not null).FirstOrDefault();
            var storeName = sourcePropertyAttribute?.StoreName;
            if (String.IsNullOrWhiteSpace(storeName))
                storeName = memberDetail.Name;
            if (!storeName.All(x => Char.IsLetterOrDigit(x) || x == '_' || x == '`'))
                throw new ArgumentException($"{nameof(StoreNameAttribute)}.{nameof(StoreNameAttribute.StoreName)}={storeName}");
            this.PropertySourceName = storeName;

            IdentityAttribute? identityAttribute = null;
            RelationAttribute? foreignIdentityAttribute = null;
            if (declaringTypeIsDataSourceEntity)
            {
                identityAttribute = memberDetail.Attributes.Select(x => x as IdentityAttribute).Where(x => x is not null).FirstOrDefault();
                foreignIdentityAttribute = memberDetail.Attributes.Select(x => x as RelationAttribute).Where(x => x is not null).FirstOrDefault();
            }
            this.IsIdentity = identityAttribute is not null;
            this.ForeignIdentity = foreignIdentityAttribute?.ForeignIdentity;
            this.IsIdentityAutoGenerated = identityAttribute is not null && identityAttribute.AutoGenerated;
            this.IsRelated = foreignIdentityAttribute is not null;

            var entityAttribute = memberDetail.TypeDetailBoxed.Attributes.Select(x => x as EntityAttribute).Where(x => x is not null).FirstOrDefault();
            this.IsDataSourceEntity = entityAttribute is not null;

            var storePropertyAttribute = memberDetail.Attributes.Select(x => x as StorePropertiesAttribute).Where(x => x is not null).FirstOrDefault();
            this.IsDataSourceNotNull = storePropertyAttribute is not null ? storePropertyAttribute.NotNull : (InnerType.IsValueType && !memberDetail.TypeDetailBoxed.IsNullable);
            this.DataSourcePrecisionLength = storePropertyAttribute is not null ? storePropertyAttribute.PrecisionLength : null;
            this.DataSourceScale = storePropertyAttribute is not null ? storePropertyAttribute.Scale : null;
            this.TextEncoding = storePropertyAttribute is not null ? storePropertyAttribute.TextEncoding : StoreTextEncoding.Unicode;
            this.DatePart = storePropertyAttribute is not null ? storePropertyAttribute.DatePart : StoreDatePart.DateTime;

            if (!this.IsDataSourceNotNull && this.IsIdentity)
                throw new Exception($"{this.Type.GetNiceName()} {this.Name} cannot be both an identity and nullable");

            this.Getter = memberDetail.GetterBoxed;
            this.Setter = memberDetail.SetterBoxed;

            this.CoreTypeSetter = CoreTypeSetterGenerator.Get(this.MemberInfo, this.CoreType, this.Type.IsArray && this.InnerCoreType == Zerra.Reflection.CoreType.Byte);
        }
    }
}
